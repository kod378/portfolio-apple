<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments.html::head">
</head>
<body class="bg-light">


<nav th:replace="fragments.html::nav"></nav>

<header th:replace="fragments.html::header"></header>

<div th:replace="fragments.html::userLoginRequestMessage"></div>

<main>
    <section class="py-5 text-center container">
        <div class="row py-lg-5 bg-dark bg-gradient">
            <div class="col-lg-6 col-md-8 mx-auto">
                <h1 class="fw-light">장바구니</h1>
                <p class="lead text-muted">Something short and leading about the collection below—its contents, the
                    creator, etc. Make it short and sweet, but not too short so folks don’t simply skip over it
                    entirely.</p>
                <p>
                    <a href="#" class="btn btn-primary my-2">Main call to action</a>
                    <a href="#" class="btn btn-secondary my-2">Secondary action</a>
                </p>
            </div>
        </div>
    </section>

    <div class="album py-5 bg-light">
        <div class="container">
            <!-- 장바구니 목록 -->
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                            <tr>
                                <th>상품이미지</th>
                                <th>상품명</th>
                                <th>가격</th>
                                <th>수량</th>
                                <th>합계</th>
                                <th>삭제</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="shoppingItemResponseDTO : ${shoppingItemResponseDTOList}">
                                <td>
                                    <img th:src="${'/uploadImage/s_' + shoppingItemResponseDTO.getFileName}" width="100px"
                                         height="100px">
                                </td>
                                <td th:text="${shoppingItemResponseDTO.itemName}"></td>
                                <td th:text="${shoppingItemResponseDTO.price}"></td>
                                <td>
                                    <div class="row">
                                        <div class="col d-flex">
                                            <a href="javascript:;" class="text-decoration-none"
                                               th:onclick="changeOrderQuantityWithId(-1, [(${shoppingItemResponseDTO.id})])">
                                                <div th:replace="fragments.html::minusIcon"></div>
                                            </a>

                                            <input type="number" th:id="${'order-quantity-' + shoppingItemResponseDTO.id}"
                                                   class="form-control w-50" th:value="${shoppingItemResponseDTO.quantity}"
                                                   th:onchange="changeOrderQuantityWithId(0, [(${shoppingItemResponseDTO.id})])">
                                            <input type="hidden" th:id="${'order-price-' + shoppingItemResponseDTO.id}"
                                                   th:value="${shoppingItemResponseDTO.price}">
                                            <input type="hidden" th:id="${'order-stock-quantity-' + shoppingItemResponseDTO.id}"
                                                   th:value="${shoppingItemResponseDTO.stockQuantity}">

                                            <a href=" javascript:;" class="text-decoration-none"
                                               th:onclick="changeOrderQuantityWithId(1, [(${shoppingItemResponseDTO.id})])">
                                                <div th:replace="fragments.html::plusIcon"></div>
                                            </a>
                                        </div>
                                    </div>
                                </td>
                                <td th:text="${shoppingItemResponseDTO.totalPrice}" name="total-price" th:id="${'total-price-' + shoppingItemResponseDTO.id}"></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary">삭제</button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 장바구니 합계 -->
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                            <tr>
                                <th>총 상품금액</th>
                                <th>총 배송비</th>
                                <th>총 결제금액</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td id="all-total-price" th:text="${allTotalPrice}"></td>
                                <td id="delivery-fee" th:text="${deliveryFee}"></td>
                                <td id="final-pay-price" th:text="${allTotalPrice + deliveryFee}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    function changeOrderQuantityWithId(changeAmount, id) {
        let orderQuantity = $('#order-quantity-' + id);
        let totalPriceText = $('#total-price-' + id);
        const price = $('#order-price-' + id).val();
        let stockQuantity = $('#order-stock-quantity-' + id);

        let quantity = parseInt(orderQuantity.val()) + changeAmount;

        function changeQuantityApi() {
            $.ajax({
                url: '/api/shoppingItem/change/' + id + '/' + quantity,
                type: 'PUT',
                success: function (data) {
                    console.log(data);
                    quantity = data.quantity;
                    stockQuantity.val(data.stockQuantity);
                },
                error: function (error) {
                    alert(error.responseJSON.message);
                    orderQuantity.val(stockQuantity);
                }
            });
        }

        if (quantity < 1) {
            quantity = 1;
        }else if (quantity > stockQuantity.val()) {
            quantity = stockQuantity.val();
            changeQuantityApi();
            quantity = stockQuantity.val(); //api 호출 후 stockQuantity 값이 변경되었을 수 있으므로 다시 할당
            alert('최대 주문 수량은 ' + stockQuantity.val() + '개 입니다.');
        }
        else{
            changeQuantityApi();
        }
        orderQuantity.val(quantity);
        totalPriceText.text(quantity * price);
        changePayPrice();
    }

    function changePayPrice() {
        let allTotalPrice = 0;
        let deliveryFee = $('#delivery-fee');
        let finalPayPrice = 0;

        $('td[name="total-price"]').each(function () {
            allTotalPrice += parseInt($(this).text());
        });
        finalPayPrice = allTotalPrice + parseInt(deliveryFee.text());
        $('#all-total-price').text(allTotalPrice);
        $('#final-pay-price').text(finalPayPrice);
    }
</script>
</body>
</html>